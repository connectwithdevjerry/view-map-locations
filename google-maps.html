<style>
  #map {
    height: 100%;
  }

  /* 
 * Optional: Makes the sample page fill the window. 
 */
  html,
  body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  .map-control {
    background-color: #000000;
    border: 1px solid #ccc;
    box-shadow: 0 2px 2px rgba(33, 33, 33, 0.4);
    font-family: "Roboto", "sans-serif";
    margin: 10px;
    display: block !important;
  }

  /* Display the control once it is inside the myMap. */
  #map .map-control {
    display: block;
  }

  .selector-control {
    font-size: 14px;
    line-height: 30px;
    padding-left: 5px;
    padding-right: 5px;
  }
</style>
<div>
  <div id="style-selector-control" class="map-control" style="opacity: 0">
    <select id="style-selector" class="selector-control" aria-label="Map style">
      <option value="default">Default</option>
      <option value="silver">Silver</option>
      <option value="night">Night mode</option>
      <option value="silver" selected="selected">Retro</option>
      <option value="hiding">Hide features</option>
    </select>
  </div>
  <div id="controls">
    <select id="locationSelect" onchange="handleChange(event)">
      <option value="">Select a location...</option>
    </select>
  </div>
  <div id="map"></div>
</div>
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&callback=initMap&v=weekly"
  defer
></script>
<script>
  let myMap;
  let geocoder;
  let markers = [];
  let infoWindow;
  let justStarted = true;

  let params = new URLSearchParams(window.location.search);

  // Get specific values
  let mycategorys = params.get("category");

  const BASE_API = "https://webflow-writing-meets-neighbourhood.onrender.com";

  const marker =
    "https://cdn.prod.website-files.com/67f5c6e6e03feab121a17b2e/683b28e6629a46401ada251f_inkwell-marker.png" ||
    "";

  let categories = {};

  let locationSelect = document.getElementById("locationSelect").innerHTML;

  function getLocation() {
    fetch(`${BASE_API}/api/cms`)
      .then(async (res) => {
        const result = await res.json();
        // console.log({ result: result.items });
        result?.items?.forEach((element) => {
          const name = element.fieldData.name;
          const place = element.fieldData["place-2"];
          if (!Object.keys(categories).includes(name)) {
            categories[name] = [];
          }
          categories[name].push(place);
          // console.log(name);
        });
        Object.keys(categories).forEach((element) => {
          locationSelect += `<option value=${element.replaceAll(
            " ",
            "-"
          )}>${element}</option>`;
        });

        console.log(categories);

        document.getElementById("locationSelect").innerHTML = locationSelect;
        if (mycategorys && justStarted) {
          justStarted = false;
          document
            .getElementById("locationSelect")
            .value = mycategorys.replaceAll(" ", "-");
          handleChange({ target: { value: mycategorys.replaceAll("-", " ") } });
        }
      })
      .then((data) => console.log(data)) // will list all sites + IDs
      .catch((err) => console.error(err));

    return true;
  }

  function addGroupMarkers(locations, group) {
    // Clear old markers
    markers.forEach((m) => m.setMap(null));
    markers = [];

    const bounds = new google.maps.LatLngBounds();

    locations.forEach((locationName) => {
      geocoder.geocode({ address: locationName }, (results, status) => {
        if (status === "OK") {
          const marker = new google.maps.Marker({
            map: myMap,
            position: results[0].geometry.location,
            title: locationName,
          });

          // Show info window on click
          marker.addListener("mouseover", () => {
            infoWindow.setContent(`<h3>${group}</h3><p>${locationName}</p>`);
            infoWindow.open(map, marker);
          });

          markers.push(marker);
          bounds.extend(results[0].geometry.location);
          myMap.fitBounds(bounds); // Adjust map to fit all markers
        } else {
          console.error("Geocode failed: " + status);
        }
      });
    });
  }
  const handleChange = (event) => {
    const value = event.target.value.replaceAll("-", " ");

    if (categories) {
      addGroupMarkers(categories[value], value);
    }
  };

  async function initMap() {
    const crossings = { lat: 40.82059103245881, lng: -73.92833846965326 };

    const letswait = await getLocation();

    geocoder = new google.maps.Geocoder();
    infoWindow = new google.maps.InfoWindow();

    // Create the map with no initial style specified.
    // It therefore has default styling.
    myMap = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 40.82059103245881, lng: -73.92833846965326 },
      zoom: 17,
      mapTypeControl: false,
      styles: stylesArray,
    });

    const markercrossings = new google.maps.Marker({
      position: crossings,
      icon: {
        url: marker,
        scaledSize: new google.maps.Size(150, 71),
      },
      map: myMap,
    });

    // Add a style-selector control to the myMap.
    const styleControl = document.getElementById("style-selector-control");

    myMap.controls[google.maps.ControlPosition.TOP_LEFT].push(styleControl);

    // Set the map's style to the initial value of the selector.
    const styleSelector = document.getElementById("style-selector");

    myMap.setOptions({ styles: styles[styleSelector.value] });
    // Apply new JSON when the user selects a different style.
    styleSelector.addEventListener("change", () => {
      myMap.setOptions({ styles: styles[styleSelector.value] });
    });
  }

  var stylesArray = [
    {
      featureType: "landscape",
      elementType: "geometry.fill",
      stylers: [
        {
          color: "#f0f0f0",
        },
      ],
    },
    {
      featureType: "landscape",
      elementType: "labels",
      stylers: [
        {
          visibility: "on",
        },
      ],
    },
    {
      featureType: "landscape.man_made",
      elementType: "geometry.fill",
      stylers: [
        {
          color: "#f0f0f0",
        },
      ],
    },
    {
      featureType: "landscape.man_made",
      elementType: "geometry.stroke",
      stylers: [
        {
          visibility: "off",
        },
      ],
    },
    {
      featureType: "poi",
      elementType: "geometry.fill",
      stylers: [
        {
          color: "#f0f0f0",
        },
      ],
    },
    {
      featureType: "poi",
      elementType: "labels",
      stylers: [
        {
          visibility: "on",
        },
      ],
    },
    {
      featureType: "poi.park",
      elementType: "geometry.fill",
      stylers: [
        {
          color: "#f0f0f0",
        },
      ],
    },
    {
      featureType: "road",
      elementType: "labels",
      stylers: [
        {
          visibility: "on",
        },
      ],
    },
    {
      featureType: "road.highway",
      stylers: [
        {
          color: "#ebebeb",
        },
      ],
    },
    {
      featureType: "road.local",
      elementType: "geometry.fill",
      stylers: [
        {
          color: "#ffffff",
        },
      ],
    },
    {
      featureType: "transit",
      elementType: "labels",
      stylers: [
        {
          color: "#ffffff",
        },
        {
          visibility: "simplified",
        },
      ],
    },
    {
      featureType: "water",
      elementType: "geometry.fill",
      stylers: [
        {
          color: "#d0dce7",
        },
      ],
    },
    {
      featureType: "water",
      elementType: "labels",
      stylers: [
        {
          color: "#ffffff",
        },
      ],
    },
  ];

  const styles = {
    default: [],
    silver: [
      {
        elementType: "geometry",
        stylers: [{ color: "#242424" }],
      },
      {
        elementType: "labels.icon",
        stylers: [{ visibility: "off" }],
      },
      {
        elementType: "labels.icon",
        elementType: "labels.text.stroke",
        stylers: [{ visibility: "off" }],
      },
      {
        elementType: "labels.text",
        stylers: [{ color: "#ffffff" }],
      },
      {
        elementType: "labels.text.stroke",
        stylers: [{ color: "#f5f5f5" }],
      },
      {
        featureType: "administrative.land_parcel",
        elementType: "labels.text.fill",
        stylers: [{ color: "#ffffff" }],
      },
      {
        featureType: "poi",
        elementType: "geometry",
        stylers: [{ color: "#242424" }],
      },
      {
        featureType: "poi",
        elementType: "labels.text.stroke",
        stylers: [{ visibility: "off" }],
      },
      {
        featureType: "poi",
        elementType: "labels.text",
        stylers: [{ color: "#ffffff" }],
      },
      {
        featureType: "poi.park",
        elementType: "geometry",
        stylers: [{ color: "#B3B766" }],
      },
      {
        featureType: "poi.park",
        elementType: "labels.text.stroke",
        stylers: [{ visibility: "off" }],
      },
      {
        featureType: "poi.park",
        elementType: "labels.text.fill",
        stylers: [{ color: "#ffffff" }],
      },
      {
        featureType: "road",
        elementType: "geometry",
        stylers: [{ color: "#000000" }],
      },
      {
        featureType: "road.arterial",
        elementType: "labels.text.stroke",
        stylers: [{ visibility: "off" }],
      },
      {
        featureType: "road.arterial",
        elementType: "labels.text",
        stylers: [{ color: "#ffffff" }],
      },
      {
        featureType: "road.highway",
        elementType: "labels.text.stroke",
        stylers: [{ visibility: "off" }],
      },
      {
        featureType: "road.highway",
        elementType: "labels.text",
        stylers: [{ color: "#ffffff" }],
      },
      {
        featureType: "road.local",
        elementType: "labels.text",
        stylers: [{ color: "#ffffff" }],
      },
      {
        featureType: "road.local",
        elementType: "labels.text.stroke",
        stylers: [{ visibility: "off" }],
      },
      {
        featureType: "transit.line",
        elementType: "geometry",
        stylers: [{ color: "#e5e5e5" }],
      },
      {
        featureType: "transit.station",
        elementType: "geometry",
        stylers: [{ color: "#eeeeee" }],
      },
      {
        featureType: "water",
        elementType: "geometry",
        stylers: [{ color: "#3D94BC" }],
      },
      {
        featureType: "water",
        elementType: "labels.text.fill",
        stylers: [{ color: "#616161" }],
      },
    ],
  };

  window.initMap = initMap;
</script>
